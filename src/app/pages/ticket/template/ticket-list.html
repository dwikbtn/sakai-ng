<section class="p-4">
    <p-toast />
    <div class="text-3xl font-bold mb-4">Ticket List</div>
    <button pButton type="button" label="New Ticket" icon="pi pi-plus" (click)="createNewTicket()" pTooltip="Create a new ticket" tooltipPosition="bottom"></button>
    <div class="toolbar flex items-center justify-between mb-4 mt-2">
        <ticket-status-tab [selectedTab]="selectedTab" [totalCount]="totalCount" [openedCount]="openedCount" [inProgressCount]="inProgressCount" [closedCount]="closedCount" (tabSelected)="selectTab($event)"></ticket-status-tab>

        <div class="controls flex items-center gap-3" style="position: relative">
            <div class="search-wrapper">
                <i class="pi pi-search search-icon"></i>
                <p-autoComplete
                    [(ngModel)]="searchQuery"
                    [suggestions]="searchSuggestions"
                    (completeMethod)="searchTickets($event)"
                    (onSelect)="onSelectSearch($event)"
                    placeholder="Search tickets, users, IDs..."
                    [minLength]="0"
                    [showEmptyMessage]="true"
                    emptyMessage="No results found"
                    styleClass="w-full"
                    inputStyleClass="w-full"
                >
                    <ng-template let-item pTemplate="item">
                        <div class="flex items-center gap-2 p-2">
                            <i
                                class="pi"
                                [ngClass]="{
                                'pi-clock': item.type === 'recent',
                                'pi-ticket': item.type === 'ticket',
                                'pi-search': item.type === 'text'
                            }"
                            ></i>
                            <div class="flex-1">
                                <div class="font-semibold">{{ item.label }}</div>
                                <div *ngIf="item.ticket" class="text-xs text-gray-500">{{ item.ticket.user }} • {{ item.ticket.priority }} • {{ statusLabel(item.ticket.status) }}</div>
                            </div>
                        </div>
                    </ng-template>
                </p-autoComplete>
                <button *ngIf="searchQuery" pButton type="button" icon="pi pi-times" class="p-button-text p-button-sm clear-search-btn" (click)="clearSearch()" pTooltip="Clear search" tooltipPosition="bottom"></button>
            </div>

            <button pButton type="button" class="p-button-outlined filter-button" [class.active-filter]="selectedPriorities.size > 0 " aria-label="Filter" (click)="toggleFilter($event)" pTooltip="Filter by priority" tooltipPosition="bottom">
                <i class="pi pi-filter"></i>
            </button>
            <button pButton type="button" class="p-button-outlined" [class.sort-active]="sortOrder !== 'none'" aria-label="Sort" (click)="toggleSort()" pTooltip="Sort by name" tooltipPosition="bottom">
                <i class="pi" [ngClass]="sortOrder === 'asc' ? 'pi-sort-amount-up' : sortOrder === 'desc' ? 'pi-sort-amount-down' : 'pi-sort'"></i>
            </button>

            <app-filter
                *ngIf="showFilter"
                [showFilter]="showFilter"
                [selectedPriorities]="selectedPriorities"
                (togglePriorityEvent)="togglePriority($event.priority, $event.event)"
                (applyFilterEvent)="applyFilter()"
                (clearFilterEvent)="clearFilter()"
            ></app-filter>
        </div>
    </div>

    <p-table [value]="filteredTickets" class="p-datatable-gridlines">
        <ng-template pTemplate="header">
            <tr>
                <th>Ticket ID</th>
                <th>Title</th>
                <!-- <th>Category</th> -->
                <!-- <th>Created At</th>
                        <th>Updated At</th> -->
                <th>User Name</th>
                <th>Priority</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </ng-template>

        <ng-template pTemplate="body" let-ticket>
            <tr>
                <td>{{ ticket.id }}</td>
                <td>
                    <div class="font-semibold">{{ ticket.title }}</div>
                    <div class="text-xs text-gray-500">{{ ticket.date }}</div>
                </td>
                <!-- <td>{{ ticket.category }}</td> -->
                <!-- <td>{{ formatDate(ticket.createdDate) }}</td>
                        <td>{{ formatDate(ticket.updatedDate) }}</td> -->
                <td>{{ ticket.user }}</td>
                <td>
                    <span class="priority-badge" [ngClass]="priorityClass(ticket.priority)">{{ ticket.priority }}</span>
                </td>
                <td>
                    <span class="status-badge" [ngClass]="{ 'status-open': ticket.status === 'open', 'status-in-progress': ticket.status === 'in-progress', 'status-closed': ticket.status === 'closed' }">{{ statusLabel(ticket.status) }}</span>
                </td>
                <td>
                    <div class="flex items-center gap-2">
                        <button pButton type="button" icon="pi pi-eye" class="p-button-text p-button-plain" (click)="viewTicket(ticket)" pTooltip="View ticket details" tooltipPosition="top"></button>

                        <button type="button" class="p-button p-component p-button-text" (click)="menu.toggle($event)" pTooltip="More actions" tooltipPosition="top">
                            <i class="pi pi-ellipsis-v"></i>
                        </button>
                        <p-popover #menu>
                            <div class="flex flex-col gap-2">
                                <button type="button" class="action-btn" (click)="closeTicket(ticket)" pTooltip="Mark ticket as closed" tooltipPosition="left">Close Ticket</button>
                                <button type="button" class="action-btn" (click)="editTicket(ticket)" pTooltip="Edit ticket details" tooltipPosition="left">Edit Ticket</button>
                                <button type="button" class="action-btn danger" (click)="deleteTicket(ticket)" pTooltip="Delete this ticket" tooltipPosition="left">Delete</button>
                            </div>
                        </p-popover>
                    </div>
                </td>
            </tr>
        </ng-template>
    </p-table>
</section>

<!-- delete confirmation modal -->
<app-delete-ticket-dialog [(visible)]="showDeleteModal" [ticket]="ticketToDelete" (confirm)="confirmDelete()"> </app-delete-ticket-dialog>
